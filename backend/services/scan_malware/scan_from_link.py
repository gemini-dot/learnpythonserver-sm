import requests
import time

VT_API_KEY = "302a775a3113d3407c7563ea6b40bc18dbc589511a576aafb36c87ff462a65db"


def upload_and_scan_directly(cloudinary_url):
    with requests.get(cloudinary_url, stream=True) as r:
        r.raise_for_status()
        url = "https://www.virustotal.com/api/v3/files"
        headers = {"x-apikey": VT_API_KEY}
        files = {"file": ("filename_temp", r.raw, r.headers.get("Content-Type"))}
        response = requests.post(url, headers=headers, files=files)

    if response.status_code == 200:
        analysis_id = response.json()["data"]["id"]
        print(
            f"✓ Đã gửi file: {cloudinary_url.split('/')[-1]}. ID: {analysis_id}",
            flush=True,
        )
        return analysis_id
    return None


def get_scan_report(analysis_id):
    if not analysis_id:
        return None
    url = f"https://www.virustotal.com/api/v3/analyses/{analysis_id}"
    headers = {"x-apikey": VT_API_KEY}
    for i in range(20):
        response = requests.get(url, headers=headers, timeout=30)
        if response.status_code == 200:
            data = response.json()["data"]["attributes"]
            status = data["status"]

            if status == "completed":
                return data["stats"]["malicious"]
            else:
                print(f"... Đang đợi quét (Lần {i+1}: {status})...", flush=True)
                time.sleep(15)
        elif response.status_code == 429:
            print("!!! Bị giới hạn API (Rate Limit), nghỉ thêm tí...", flush=True)
            time.sleep(30)

    return "Timeout"


def scan_multiple_files(url_list):
    results = {}
    for url in url_list:
        print(f"\n--- Xử lý: {url.split('/')[-1]} ---")
        aid = upload_and_scan_directly(url)
        count = get_scan_report(aid)
        results[url] = count

        print(f"Đợi 15 giây để VirusTotal nghỉ ngơi...", flush=True)
        time.sleep(15)
    return results


def thong_bao_trang_thai(count):
    if isinstance(count, int):
        if count == 0:
            return "SAFE"
        return "MALICIOUS"
    return "UNKNOWN"


def kiem_tra(user_files):
    final_report = scan_multiple_files(user_files)

    ket_qua_tong_hop = []

    for url, count in final_report.items():
        trang_thai = thong_bao_trang_thai(count)
        info = {
            "url": url,
            "filename": url.split("/")[-1],
            "malicious_count": count,
            "status": trang_thai,
        }
        ket_qua_tong_hop.append(info)
    return ket_qua_tong_hop
