from flask import request,jsonify
from configs.db import db
from services.scan_malware.chuc_nang.get_link import get_link_file_cloudinary
from services.scan_malware.scan_from_link import kiem_tra
import time
import threading

def scan_link_controller():
    nguoi_dung = request.cookies.get("user_gmail")
    if not nguoi_dung:
        return jsonify({"status": "error", "message": "Login đi og!"}), 401
    
    ket_qua = get_link_file_cloudinary(str(nguoi_dung))
    
    if not ket_qua or len(ket_qua) == 0:
        return jsonify({"status": "success", "message": "No files found."}), 200

    thread = threading.Thread(target=xu_ly_quet_va_gui_mail, args=(ket_qua, nguoi_dung))
    thread.start()

    return jsonify({
        "status": "processing",
        "message": "Hệ thống đang quét ngầm, có biến tui sẽ gửi Mail cho og!"
    }), 202

vt_semaphore = threading.Semaphore(1)

def xu_ly_quet_va_gui_mail(danh_sach_url, email_nguoi_dung):
    try:
        with vt_semaphore:
            print(f"--- [QUYỀN TRUY CẬP] {email_nguoi_dung} bắt đầu dùng API VT ---", flush=True)
            
            noi_luu_tru = db['file_info']
            ket_qua_quet = kiem_tra(danh_sach_url)
            
            if not ket_qua_quet or len(ket_qua_quet) == 0:
                print("Không có kết quả trả về từ VirusTotal", flush=True)
                return

            co_malware = False
            for file in ket_qua_quet:
                url = file.get('url')
                if not url: continue 
                
                status_quet = file.get('status', 'UNKNOWN')
                print(f"--- Đang update DB cho file: {url} | Trạng thái: {status_quet}", flush=True)
                    
                noi_luu_tru.update_one(
                    { "url": str(url) }, 
                    { "$set": { "muc_do": str(status_quet) } }
                )
                    
                if status_quet == 'MALICIOUS':
                    co_malware = True       

            if co_malware:
                print(f"!!! PHÁT HIỆN MÃ ĐỘC - ĐANG GỬI MAIL CHO {email_nguoi_dung}", flush=True)
            print(f"--- [GIẢI PHÓNG] {email_nguoi_dung} đã xong, nhường chỗ cho người sau ---", flush=True)
    except Exception as e:
        print(f"loi {e}",flush=True)